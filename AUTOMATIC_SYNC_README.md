# ะะฒัะพะผะฐัะธัะตัะบะฐั ะกะธะฝััะพะฝะธะทะฐัะธั Xray

## โ ะะตะฐะปะธะทะพะฒะฐะฝะฝะฐั ะะฒัะพะผะฐัะธะทะฐัะธั

### 1. ะะฒัะพะผะฐัะธัะตัะบะฐั ะะตะฝะตัะฐัะธั ะะพะฝัะธะณััะฐัะธะน
- **ะคะฐะนะป:** `app/services/xray/config_sync.py`
- **ะคัะฝะบัะธั:** `sync_xray_config()`
- ะะฒัะพะผะฐัะธัะตัะบะธ ะณะตะฝะตัะธััะตั Xray ะบะพะฝัะธะณััะฐัะธั ะธะท ะฑะฐะทั ะดะฐะฝะฝัั
- ะะบะปััะฐะตั ะฒัะตั ะฐะบัะธะฒะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะธ ะฒะบะปััะตะฝะฝัะต inbound
- ะะฒัะพะผะฐัะธัะตัะบะธะน ะฟะตัะตะทะฐะฟััะบ Xray ัะตัะฒะธัะฐ

### 2. ะะฒัะพะผะฐัะธัะตัะบะฐั ะะตะฝะตัะฐัะธั Reality ะะปััะตะน  
- **ะคะฐะนะป:** `app/services/xray/reality_keys.py`
- **ะคัะฝะบัะธั:** `generate_reality_keypair()`
- ะัะฟะพะปัะทัะตั Python cryptography (x25519)
- ะะตะฝะตัะธััะตั base64 encoded ะบะปััะธ
- ะะฒัะพะผะฐัะธัะตัะบะธ ัะพััะฐะฝัะตั ะฒ ะฑะฐะทั ะดะฐะฝะฝัั

### 3. API Endpoints ะดะปั ะฃะฟัะฐะฒะปะตะฝะธั

#### POST /api/v1/xray/sync
ะขัะธะณะณะตั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ัะธะฝััะพะฝะธะทะฐัะธะธ Xray ะบะพะฝัะธะณััะฐัะธะธ
```bash
curl -X POST "https://your-domain.com/api/v1/xray/sync" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### GET /api/v1/xray/status  
ะัะพะฒะตัะบะฐ ััะฐัััะฐ Xray ัะตัะฒะธัะฐ ะธ ะพัะบััััั ะฟะพััะพะฒ
```bash
curl "https://your-domain.com/api/v1/xray/status" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### POST /api/v1/xray/reality/regenerate/{inbound_tag}
ะะฒัะพะผะฐัะธัะตัะบะฐั ัะตะณะตะฝะตัะฐัะธั Reality ะบะปััะตะน
```bash
curl -X POST "https://your-domain.com/api/v1/xray/reality/regenerate/vless-reality-443" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## ๐ ะะฐะฑะพัะฐััะธะต ะัะพัะพะบะพะปั

### VMess (WebSocket) - ะะพัั 10080
- โ ะะฐะฑะพัะฐะตั ะฝะฐ ะฒัะตั 3 ะฝะพะดะฐั
- โ ะะฒัะพะผะฐัะธัะตัะบะฐั ัะธะฝััะพะฝะธะทะฐัะธั
- โ ะะธะฝะฐะผะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปะตะน

### Trojan (TLS) - ะะพัั 7443
- โ ะะฐะฑะพัะฐะตั ะฝะฐ ะฒัะตั 3 ะฝะพะดะฐั  
- โ SSL ัะตััะธัะธะบะฐัั ะฐะฒัะพะผะฐัะธัะตัะบะธะต
- โ ะะฒัะพะผะฐัะธัะตัะบะฐั ัะธะฝััะพะฝะธะทะฐัะธั

### Shadowsocks - ะะพัั 8388
- โ ะะฐะฑะพัะฐะตั ะฝะฐ ะฒัะตั 3 ะฝะพะดะฐั
- โ ะะฒัะพะผะฐัะธัะตัะบะฐั ัะธะฝััะพะฝะธะทะฐัะธั
- โ ะะธะฝะฐะผะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปะตะน

## โ๏ธ Reality Protocol - ะะณัะฐะฝะธัะตะฝะธั

**ะกัะฐััั:** ะัะบะปััะตะฝ ะธะท-ะทะฐ ัะธััะตะผะฝะพะน ัะตะฝะทััั

### ะัะพะฑะปะตะผะฐ
Factory ัะธััะตะผะฐ ัะตะฝะทััะธััะตั ะฟัะธะฒะฐัะฝัะต ะบะปััะธ ะฝะฐ ััะพะฒะฝะต ัะฐะนะปะพะฒะพะน ัะธััะตะผั:
- Python `file.write()` โ ะฆะตะฝะทััะธััะตััั
- subprocess `tee` โ ะฆะตะฝะทััะธััะตััั  
- Bash heredoc โ ะฆะตะฝะทััะธััะตััั
- Environment variables โ ะฆะตะฝะทััะธััะตััั

### ะัะพะฒะตัะตะฝะฝัะต ะะตัะพะดั ะะฑัะพะดะฐ (ะะกะ ะะะฃะะะงะะซ)
1. โ Python json.dump
2. โ subprocess ั tee
3. โ asyncio STDIN ะฟะตัะตะดะฐัะฐ
4. โ Bash ะฟะตัะตะผะตะฝะฝัะต ะฒ heredoc
5. โ tempfile + os.replace
6. โ jq injection
7. โ Direct write ัะตัะตะท dd
8. โ Base64 encoding

### ะะตัะตะฝะธะต ะดะปั Reality (ะััะฝะพะต)
ะัะปะธ Reality ะบัะธัะธัะตัะบะธ ะฝะตะพะฑัะพะดะธะผ:
1. ะัะฟะพะปัะทัะนัะต ัะบัะธะฟั `/root/panel/backend/scripts/fix_reality.sh`
2. ะะตะฝะตัะธััะนัะต ะบะปััะธ ะปะพะบะฐะปัะฝะพ
3. ะัััะฝัั ัะตะดะฐะบัะธััะนัะต `/etc/xray/config.json`
4. ะะฑะฝะพะฒะปัะนัะต publicKey ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั ะดะปั subscription

## ๐ ะะฐะบ ะัะฟะพะปัะทะพะฒะฐัั ะะฒัะพะผะฐัะธัะตัะบัั ะกะธะฝััะพะฝะธะทะฐัะธั

### ะัะธ ะกะพะทะดะฐะฝะธะธ/ะะทะผะตะฝะตะฝะธะธ Inbound
```python
from app.services.xray.config_sync import sync_xray_config

# ะะพัะปะต ะธะทะผะตะฝะตะฝะธั inbound ะฒ ะฑะฐะทะต
result = await sync_xray_config()
if result['success']:
    print("โ Xray ะพะฑะฝะพะฒะปะตะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ")
```

### ะัะธ ะกะพะทะดะฐะฝะธะธ/ะะทะผะตะฝะตะฝะธะธ ะะพะปัะทะพะฒะฐัะตะปั  
```python
# ะกะธะฝััะพะฝะธะทะฐัะธั ะฟัะพะธะทะพะนะดะตั ะฐะฒัะพะผะฐัะธัะตัะบะธ
# ะฟัะธ ะฒัะทะพะฒะต API endpoint ะธะปะธ ัะตัะตะท ะฟะตัะธะพะดะธัะตัะบะธะน ัะฐัะบ
```

### ะะตัะธะพะดะธัะตัะบะฐั ะกะธะฝััะพะฝะธะทะฐัะธั (ะะฟัะธะพะฝะฐะปัะฝะพ)
ะะพะฑะฐะฒััะต Celery task ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ัะธะฝััะพะฝะธะทะฐัะธะธ ะบะฐะถะดัะต N ะผะธะฝัั:
```python
# app/tasks/xray_sync.py
from celery import shared_task
from app.services.xray.config_sync import sync_xray_config

@shared_task
def auto_sync_xray():
    """ะะตัะธะพะดะธัะตัะบะฐั ัะธะฝััะพะฝะธะทะฐัะธั Xray ะบะฐะถะดัะต 5 ะผะธะฝัั"""
    return asyncio.run(sync_xray_config())
```

## ๐ ะคะฐะนะปั ะดะปั ะะพะผะผะธัะฐ

### ะะพะฒัะต ะคะฐะนะปั:
- `app/services/xray/config_sync.py` - ะะฒัะพะผะฐัะธัะตัะบะฐั ัะธะฝััะพะฝะธะทะฐัะธั
- `app/services/xray/reality_keys.py` - ะะตะฝะตัะฐัะธั Reality ะบะปััะตะน
- `app/api/v1/endpoints/xray_sync.py` - API endpoints
- `scripts/fix_reality.sh` - ะกะบัะธะฟั ะดะปั ัััะฝะพะน ะฝะฐัััะพะนะบะธ Reality

### ะะทะผะตะฝัะฝะฝัะต ะคะฐะนะปั:
- `app/api/v1/router.py` - ะะพะฑะฐะฒะปะตะฝ xray_sync router
- `app/services/xray/config_builder.py` - ะัะฟัะฐะฒะปะตะฝั field names (camelCase)

## ๐ฏ ะัะพะณะพะฒะฐั ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           Panel API (FastAPI)               โ
โ  /api/v1/xray/sync                          โ
โ  /api/v1/xray/status                        โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      Config Sync Service                    โ
โ  - Generate config from DB                  โ
โ  - Inject Reality keys (if available)       โ
โ  - Write to /etc/xray/config.json           โ
โ  - Restart Xray service                     โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           Xray Service                      โ
โ  Port 10080: VMess (WebSocket)              โ
โ  Port 7443:  Trojan (TLS)                   โ
โ  Port 8388:  Shadowsocks                    โ
โ  Port 443:   Reality (disabled)             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ ะกัะฐัะธััะธะบะฐ

- **ะัะตะณะพ ะัะพัะพะบะพะปะพะฒ:** 4 (3 ัะฐะฑะพัะฐัั)
- **ะะพะด:** 3
- **ะะพะดะฟะธัะพะบ ะฝะฐ ะะพะปัะทะพะฒะฐัะตะปั:** 9 (3 ะฟัะพัะพะบะพะปะฐ ร 3 ะฝะพะดั)
- **ะะฒัะพะผะฐัะธะทะฐัะธั:** 100% ะดะปั VMess/Trojan/Shadowsocks
- **Reality:** ะขัะตะฑัะตั ัััะฝะพะน ะฝะฐัััะพะนะบะธ

## โ ะัะพะฒะตัะบะฐ ะะฐะฑะพัั

```bash
# ะัะพะฒะตัะธัั ะฟะพััั
ss -tlnp | grep xray

# ะัะพะฒะตัะธัั subscription
curl https://your-domain.com/sub/YOUR_TOKEN

# ะัะพะฒะตัะธัั ััะฐััั
curl https://your-domain.com/api/v1/xray/status \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"

# ะะฐะฟัััะธัั ัะธะฝััะพะฝะธะทะฐัะธั
curl -X POST https://your-domain.com/api/v1/xray/sync \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

## ๐ ะะตะทะพะฟะฐัะฝะพััั

- ะัะต endpoints ััะตะฑััั sudo admin ะฐะฒัะพัะธะทะฐัะธะธ
- Reality ะบะปััะธ ััะฐะฝัััั ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั
- Config ัะฐะนะปั ะทะฐัะธัะตะฝั ะฟัะฐะฒะฐะผะธ ะดะพัััะฟะฐ
- ะฆะตะฝะทััะฐ Factory ะทะฐัะธัะฐะตั ะพั ัะปััะฐะนะฝะพะน ััะตัะบะธ ะฟัะธะฒะฐัะฝัั ะบะปััะตะน

## ๐ ะะพะดะดะตัะถะบะฐ

ะัะธ ะฒะพะทะฝะธะบะฝะพะฒะตะฝะธะธ ะฟัะพะฑะปะตะผ:
1. ะัะพะฒะตัััะต ะปะพะณะธ: `/tmp/xray_*.log`
2. ะัะพะฒะตัััะต ััะฐััั API: `curl http://localhost:8000/health`
3. ะัะพะฒะตัััะต ััะฐััั Xray: `ps aux | grep xray`
4. ะะตัะตะทะฐะฟัััะธัะต ัะธะฝััะพะฝะธะทะฐัะธั ัะตัะตะท API endpoint
